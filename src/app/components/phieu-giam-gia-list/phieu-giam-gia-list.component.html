<div class="phieu-giam-gia-list-container">
  <!-- Search Filter Section -->
  <div class="filter-card">
    <div class="filter-header">
      <i class="bi bi-funnel section-icon"></i>
      <h3 class="section-title">Bộ Lọc Tìm Kiếm</h3>
    </div>

    <div class="filter-content">
      <!-- Row 1: Search, Type, Status -->
      <div class="filter-group">
        <label>Tìm kiếm phiếu</label>
        <div class="search-input-group">
          <i class="bi bi-search search-icon"></i>
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (input)="applyFilters()"
            placeholder="Mã phiếu, tên phiếu..."
            class="search-input"
          />
        </div>
      </div>

      <div class="filter-group">
        <label>Loại phiếu</label>
        <select [(ngModel)]="selectedType" (change)="applyFilters()" class="filter-select">
          <option value="all">Tất cả loại phiếu</option>
          <option value="tien_mat">Tiền mặt</option>
          <option value="phan_tram">Phần trăm</option>
        </select>
      </div>

      <div class="filter-group">
        <label>Trạng thái</label>
        <select [(ngModel)]="selectedStatus" (change)="applyFilters()" class="filter-select">
          <option value="all">Tất cả trạng thái</option>
          <option value="sap_dien_ra">Sắp diễn ra</option>
          <option value="dang_dien_ra">Đang diễn ra</option>
          <option value="ket_thuc">Kết thúc</option>
        </select>
      </div>

      <!-- Row 2: Date Range and Value Range -->
      <div class="filter-group date-range-group">
        <label>Khoảng thời gian</label>
        <div class="date-range">
          <div class="date-input-group">
            <input
              type="date"
              [(ngModel)]="startDate"
              (change)="applyFilters()"
              class="date-input"
            />
            <i class="bi bi-calendar-date calendar-icon"></i>
          </div>
          <span class="date-separator">đến</span>
          <div class="date-input-group">
            <input type="date" [(ngModel)]="endDate" (change)="applyFilters()" class="date-input" />
            <i class="bi bi-calendar-date calendar-icon"></i>
          </div>
        </div>
      </div>


      <!-- Empty div to maintain grid layout -->
      <div class="filter-group"></div>

      <!-- Action Buttons -->
      <div class="filter-actions">
        <button class="btn-reset" (click)="resetFilters()">Đặt lại bộ lọc</button>
        <button class="btn-export" (click)="exportToExcel()">Xuất Excel</button>
        <button class="btn-add" (click)="addPhieuGiamGia()">Thêm Phiếu Giảm Giá</button>
      </div>
    </div>
  </div>

  <!-- List Section -->
  <div class="list-card">
    <div class="list-header">
      <i class="bi bi-table section-icon"></i>
      <h3 class="section-title">Danh Sách Phiếu Giảm Giá</h3>
      <div class="header-actions">
        <button
          class="btn-refresh"
          (click)="refreshData()"
          [disabled]="loading"
          title="Làm mới dữ liệu"
        >
          <i class="bi bi-arrow-clockwise" [class.spinning]="loading"></i>
        </button>
        <span class="item-count">{{ totalItems }} phiếu giảm giá</span>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
      <div class="loading-spinner">
        <i class="bi bi-arrow-clockwise"></i>
        <span>Đang tải dữ liệu...</span>
      </div>
    </div>

    <!-- Data Table -->
    <div class="table-container" *ngIf="!loading">
      <table class="data-table">
        <thead>
          <tr>
            <th>STT</th>
            <th>Mã Phiếu</th>
            <th>Giá Trị</th>
            <th>Số lượng</th>
            <th>Loại Phiếu</th>
            <th>Trạng Thái</th>
            <th>Ngày Bắt Đầu</th>
            <th>Ngày Kết Thúc</th>
            <th>Hành Động</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let phieu of paginatedList; let i = index" class="table-row">
            <td>{{ (currentPage - 1) * itemsPerPage + i + 1 }}</td>
            <td class="phieu-code">
              <a href="#" class="code-link">{{ phieu.maPhieu }}</a>
              <div class="code-date">{{ formatDate(phieu.ngayBatDau) }}</div>
            </td>
            <td class="phieu-value">
              <div class="value-amount">{{ formatCurrency(phieu.giaTriGiam) }}</div>
              <div class="min-order">Đơn tối thiểu: {{ formatCurrency(phieu.giaTriToiThieu) }}</div>
            </td>
            <td>{{ phieu.soLuongDung }}</td>
            <td>
              <span class="type-badge" [ngClass]="getTypeClass(phieu.loaiPhieuGiamGia)">
                {{ getTypeText(phieu.loaiPhieuGiamGia) }}
              </span>
            </td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(phieu)">
                {{ getStatusText(phieu) }}
              </span>
            </td>
            <td>{{ formatDate(phieu.ngayBatDau) }}</td>
            <td>{{ formatDate(phieu.ngayKetThuc) }}</td>
            <td class="actions">
              <div class="toggle-switch" [class.active]="phieu.trangThai" [class.updating]="phieu.isUpdating">
                <input
                  type="checkbox"
                  [checked]="phieu.trangThai"
                  (click)="toggleStatus(phieu, $event)"
                  class="toggle-input"
                  [disabled]="phieu.isUpdating"
                />
                <span class="toggle-slider">
                  <span *ngIf="phieu.isUpdating" class="loading-spinner"></span>
                </span>
              </div>
              <button class="btn-edit" (click)="editPhieuGiamGia(phieu)" title="Chỉnh sửa" [disabled]="phieu.isUpdating">
                <i class="bi bi-pencil"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Empty State -->
      <div *ngIf="!loading && paginatedList.length === 0" class="empty-state">
        <i class="bi bi-inbox"></i>
        <h4>Không có dữ liệu</h4>
        <p>Chưa có phiếu giảm giá nào trong hệ thống</p>
        <button class="btn-add" (click)="addPhieuGiamGia()">
          <i class="bi bi-plus"></i>
          Thêm phiếu giảm giá đầu tiên
        </button>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <button class="page-btn" [disabled]="currentPage === 1" (click)="previousPage()">
        <i class="bi bi-chevron-left"></i>
      </button>

      <!-- Page Numbers -->
      <div class="page-numbers">
        <button 
          *ngFor="let page of getPageNumbers()" 
          class="page-number-btn"
          [class.active]="page === currentPage"
          [disabled]="page === '...'"
          (click)="onPageNumberClick(page)">
          {{ page }}
        </button>
      </div>

      <button class="page-btn" [disabled]="currentPage === totalPages" (click)="nextPage()">
        <i class="bi bi-chevron-right"></i>
      </button>

      <span class="page-info">Trang {{ currentPage }} / {{ totalPages }} ({{ totalItems }} phiếu)</span>
    </div>
  </div>

  <!-- Error State - Removed to avoid affecting table structure -->

  <!-- Edit Modal -->
  <div *ngIf="showEditModal" class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h4>Chỉnh sửa Phiếu Giảm Giá</h4>
        <button type="button" class="btn-close" (click)="closeEditModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <div class="modal-body">
        <!-- General error message -->
        <div *ngIf="hasEditFieldError('general')" class="alert alert-danger" style="margin-bottom: 20px;">
          <i class="bi bi-exclamation-triangle"></i>
          {{ getEditFieldError('general') }}
        </div>
        
        <form>
          <div class="form-row">
            <div class="form-group">
              <label>Mã Phiếu</label>
              <input
                type="text"
                [(ngModel)]="editForm.maPhieu"
                class="form-control"
                [class.is-invalid]="hasEditFieldError('maPhieu')"
                name="maPhieu"
                (blur)="onEditFieldBlur('maPhieu')"
              />
              <div *ngIf="hasEditFieldError('maPhieu')" class="invalid-feedback">
                {{ getEditFieldError('maPhieu') }}
              </div>
            </div>
            <div class="form-group">
              <label>Tên Phiếu</label>
              <input
                type="text"
                [(ngModel)]="editForm.tenPhieuGiamGia"
                class="form-control"
                [class.is-invalid]="hasEditFieldError('tenPhieuGiamGia')"
                name="tenPhieuGiamGia"
                (blur)="onEditFieldBlur('tenPhieuGiamGia')"
                (input)="onEditFieldChange('tenPhieuGiamGia')"
              />
              <div *ngIf="hasEditFieldError('tenPhieuGiamGia')" class="invalid-feedback">
                {{ getEditFieldError('tenPhieuGiamGia') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Loại Phiếu</label>
              <select
                [(ngModel)]="editForm.loaiPhieuGiamGia"
                class="form-control"
                name="loaiPhieuGiamGia"
              >
                <option [ngValue]="true">Tiền mặt</option>
                <option [ngValue]="false">Phần trăm</option>
              </select>
            </div>
            <div class="form-group">
              <label>Trạng thái</label>
              <select [(ngModel)]="editForm.trangThai" class="form-control" name="trangThai">
                <option value="sap_dien_ra">Sắp diễn ra</option>
                <option value="dang_dien_ra">Đang diễn ra</option>
                <option value="ket_thuc">Kết thúc</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Giá trị giảm</label>
              <div class="input-group">
                <input
                  type="number"
                  [(ngModel)]="editForm.giaTriGiam"
                  class="form-control"
                  [class.is-invalid]="hasEditFieldError('giaTriGiam')"
                  name="giaTriGiam"
                  min="0"
                  (blur)="onEditFieldBlur('giaTriGiam')"
                />
                <span class="input-group-text">{{ editForm.loaiPhieuGiamGia ? 'VND' : '%' }}</span>
              </div>
              <div *ngIf="hasEditFieldError('giaTriGiam')" class="invalid-feedback">
                {{ getEditFieldError('giaTriGiam') }}
              </div>
            </div>
            <div class="form-group">
              <label>Giá trị tối thiểu</label>
              <div class="input-group">
                <input
                  type="number"
                  [(ngModel)]="editForm.giaTriToiThieu"
                  class="form-control"
                  [class.is-invalid]="hasEditFieldError('giaTriToiThieu')"
                  name="giaTriToiThieu"
                  min="0"
                  (blur)="onEditFieldBlur('giaTriToiThieu')"
                />
                <span class="input-group-text">{{ editForm.loaiPhieuGiamGia ? 'VND' : '%' }}</span>
              </div>
              <div *ngIf="hasEditFieldError('giaTriToiThieu')" class="invalid-feedback">
                {{ getEditFieldError('giaTriToiThieu') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Số tiền tối đa</label>
              <div class="input-group">
                <input
                  type="number"
                  [(ngModel)]="editForm.soTienToiDa"
                  class="form-control"
                  [class.is-invalid]="hasEditFieldError('soTienToiDa')"
                  name="soTienToiDa"
                  min="0"
                  (blur)="onEditFieldBlur('soTienToiDa')"
                />
                <span class="input-group-text">VND</span>
              </div>
              <div *ngIf="hasEditFieldError('soTienToiDa')" class="invalid-feedback">
                {{ getEditFieldError('soTienToiDa') }}
              </div>
            </div>
            <div class="form-group">
              <label>Hóa đơn tối thiểu</label>
              <div class="input-group">
                <input
                  type="number"
                  [(ngModel)]="editForm.hoaDonToiThieu"
                  class="form-control"
                  [class.is-invalid]="hasEditFieldError('hoaDonToiThieu')"
                  name="hoaDonToiThieu"
                  min="0"
                  (blur)="onEditFieldBlur('hoaDonToiThieu')"
                />
                <span class="input-group-text">VND</span>
              </div>
              <div *ngIf="hasEditFieldError('hoaDonToiThieu')" class="invalid-feedback">
                {{ getEditFieldError('hoaDonToiThieu') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Số lượng</label>
              <input
                type="number"
                [(ngModel)]="editForm.soLuongDung"
                class="form-control"
                [class.is-invalid]="hasEditFieldError('soLuongDung')"
                name="soLuongDung"
                min="0"
                (blur)="onEditFieldBlur('soLuongDung')"
              />
              <div *ngIf="hasEditFieldError('soLuongDung')" class="invalid-feedback">
                {{ getEditFieldError('soLuongDung') }}
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Ngày bắt đầu</label>
              <input
                type="date"
                [(ngModel)]="editForm.ngayBatDau"
                class="form-control"
                [class.is-invalid]="hasEditFieldError('ngayBatDau')"
                name="ngayBatDau"
                (blur)="onEditFieldBlur('ngayBatDau')"
                (change)="onEditDateChange()"
              />
              <div *ngIf="hasEditFieldError('ngayBatDau')" class="invalid-feedback">
                {{ getEditFieldError('ngayBatDau') }}
              </div>
            </div>
            <div class="form-group">
              <label>Ngày kết thúc</label>
              <input
                type="date"
                [(ngModel)]="editForm.ngayKetThuc"
                class="form-control"
                [class.is-invalid]="hasEditFieldError('ngayKetThuc')"
                name="ngayKetThuc"
                (blur)="onEditFieldBlur('ngayKetThuc')"
                (change)="onEditDateChange()"
              />
              <div *ngIf="hasEditFieldError('ngayKetThuc')" class="invalid-feedback">
                {{ getEditFieldError('ngayKetThuc') }}
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-secondary"
          (click)="closeEditModal()"
          [disabled]="isUpdating"
        >
          Hủy
        </button>
        <button
          type="button"
          class="btn btn-warning"
          (click)="testValidation()"
          style="margin-right: 10px;"
          *ngIf="false"
        >
          Test Validation
        </button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="updatePhieuGiamGia()"
          [disabled]="isUpdating"
        >
          <span *ngIf="isUpdating" class="spinner-border spinner-border-sm" role="status"></span>
          {{ isUpdating ? 'Đang cập nhật...' : 'Cập nhật' }}
        </button>
      </div>
    </div>
  </div>
</div>
